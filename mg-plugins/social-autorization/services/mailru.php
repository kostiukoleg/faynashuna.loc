<?php
 new mailru; class mailru { protected static $setting = array ( 0 => array('name' => 'ID', 'type' => 'text', 'value' => '', 'title' => 'Введите ID'), 1 => array('name' => 'Секретный ключ', 'type' => 'password', 'value' => '', 'title' => 'Введите cекретный ключ'), 2 => array('name' => 'Адрес главной страницы', 'type' => 'info', 'value' => '', 'title' => 'Укажите данную строку в адресе главной страницы') ); protected static $info = array ( 'name' => 'Mail.ru', 'title' => 'Войти через Mail.ru', 'abbreviation' => 'mailru', 'instruction' => '
      <span>1) Создайте новое приложение пройдя по ссылке : <a id="instruction-link" href="http://api.mail.ru/sites/my/add" target="_blank" title="Активация сервиса авторизации">Клик</a></span>
      <span>2) Укажите в поле "Название" название вашего приложения, а в "Адрес главной страницы" укажите значение из поля настроек обработчика.</span>
      <span>2) Выполните настройку сайта.</span>      
      <span>3) После успешной настройки, скопируйте необходимые данные из настроек приложения в настройки обработчика.</span>      
    ', 'author' => 'Александр Шамарин (alexsandrshamarin@yandex.ru)', 'version' => '1.0.1 build(104)', 'active' => 0 ); public static function information(&$result) { $result = self::$info + array('setting' => self::$setting); $result['setting'][2]['value'] = SITE.'/sociallogin'; } public static function redirection($setting) { $client_id = $setting[0]; $redirect_uri = $setting[2]; $params = array( 'client_id' => $client_id, 'response_type' => 'code', 'redirect_uri' => $redirect_uri ); header('Location: https://connect.mail.ru/oauth/authorize?' . urldecode(http_build_query($params))); } public static function data($setting, $in, &$result) { $client_id = $setting[0]; $client_secret = $setting[1]; $redirect_uri = $setting[2]; $result = array(); $params = array ( 'client_id' => $client_id, 'client_secret' => $client_secret, 'grant_type' => 'authorization_code', 'code' => $in['code'], 'redirect_uri' => $redirect_uri ); $tokenInfo = json_decode(curlPost('https://connect.mail.ru/oauth/token', $params), true); if (isset($tokenInfo['access_token'])) { $sign = md5("app_id={$client_id}method=users.getInfosecure=1session_key={$tokenInfo['access_token']}{$client_secret}"); $params = array( 'method' => 'users.getInfo', 'secure' => '1', 'app_id' => $client_id, 'session_key' => $tokenInfo['access_token'], 'sig' => $sign ); $userInfo = json_decode(file_get_contents('http://www.appsmail.ru/platform/api?'.urldecode(http_build_query($params))), true); if (isset($userInfo[0]['uid'])) { $userInfo = array_shift($userInfo); $result = array( 'id' => $userInfo['uid'], 'full_name' => $userInfo['first_name'].' '.$userInfo['last_name'], 'first_name' => $userInfo['first_name'], 'last_name' => $userInfo['last_name'], 'address' => '', 'sex' => $userInfo['sex'], 'birthday' => $userInfo['birthday'], 'email' => $userInfo['email'], ); } } } } 