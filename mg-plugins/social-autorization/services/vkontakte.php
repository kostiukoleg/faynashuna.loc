<?php
 new vkontakte; class vkontakte { protected static $setting = array ( 0 => array('name' => 'Id приложения', 'type' => 'text', 'value' => '', 'title' => 'Введите id приложения'), 1 => array('name' => 'Защищенный ключ', 'type' => 'password', 'value' => '', 'title' => 'Введите Защищенный ключ'), 2 => array('name' => 'Адрес сайта', 'type' => 'info', 'value' => '', 'title' => 'Укажите данную строку в Адресе сайта') ); protected static $info = array ( 'name' => 'Вконтакте', 'title' => 'Войти с помощью Вконтакте', 'abbreviation' => 'vkontakte', 'instruction' => '
      <span>1) Создайте новое приложение пройдя по ссылке : <a id="instruction-link" href="http://vk.com/editapp?act=create" target="_blank" title="Активация сервиса авторизации">Клик</a></span>
      <span>2) Укажите в поле "Адрес сайта" значение из поля настроек обработчика.</span>
      <span>2) Добавьте ваш базовый домен в поле "Базовый домен".</span>      
      <span>3) После успешного создания приложения, скопируйте необходимые данные из настроек приложения в настройки обработчика.</span>
    ', 'author' => 'Александр Шамарин (alexsandrshamarin@yandex.ru)', 'version' => '1.0.1 build(104)', 'active' => 0 ); public static function information(&$result) { $result = self::$info + array('setting' => self::$setting); $result['setting'][2]['value'] = SITE.'/sociallogin'; } public static function redirection($setting) { $client_id = $setting[0]; $redirect_uri = $setting[2]; $params = array( 'client_id' => $client_id, 'response_type' => 'code', 'redirect_uri' => $redirect_uri ); header('Location: http://oauth.vk.com/authorize?'.urldecode(http_build_query($params))); } public static function data($setting, $in, &$result) { $client_id = $setting[0]; $client_secret = $setting[1]; $redirect_uri = $setting[2]; $result = array(); $params = array ( 'client_id' => $client_id, 'client_secret' => $client_secret, 'code' => $in['code'], 'redirect_uri' => $redirect_uri ); $token = json_decode(curlPost('https://oauth.vk.com/access_token', $params), true); if (isset($token['access_token'])) { $params = array( 'uids' => $token['user_id'], 'fields' => 'uid,first_name,last_name,screen_name,sex,bdate,photo_big,country,city', 'access_token' => $token['access_token'] ); $userInfo = json_decode(file_get_contents('https://api.vk.com/method/users.get?'.urldecode(http_build_query($params))), true); if (isset($userInfo['response'][0]['uid'])) { $userInfo = $userInfo['response'][0]; $countryInfo = json_decode(file_get_contents('https://api.vk.com/method/database.getCountriesById?'.urldecode('country_ids='.$userInfo['country'])), true); $sityInfo = json_decode(file_get_contents('https://api.vk.com/method/database.getCitiesById?'.urldecode('city_ids='.$userInfo['city'])), true); $addr = $countryInfo['response'][0]['name'].','.$sityInfo['response'][0]['name']; $result = array ( 'id' => $userInfo['uid'], 'full_name' => $userInfo['first_name'].' '. $userInfo['last_name'], 'first_name' => $userInfo['first_name'], 'last_name' => $userInfo['last_name'], 'sex' => $userInfo['sex'], 'birthday' => $userInfo['bdate'], 'address' => $addr, 'email' => '' ); } } } } 